name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-test:
    name: Build & Test (Java ${{ matrix.java }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '17', '21' ]
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: temurin
          cache: maven

      - name: Build and run unit tests
        run: mvn -B verify -pl '!it-tests'

  integration-tests:
    name: Integration Tests (${{ matrix.spark_profile }})
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        spark_profile: [ 'spark35', 'spark35-scala212', 'spark40', 'spark41' ]
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: temurin
          cache: maven

      - name: Run integration tests
        run: mvn -B verify -pl it-tests -am -P${{ matrix.spark_profile }}

  publish:
    name: Publish Release Artifacts
    runs-on: ubuntu-latest
    needs: [ build-and-test, integration-tests ]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Set release version
        run: mvn -B versions:set -DnewVersion=${{ steps.version.outputs.VERSION }} -DgenerateBackupPoms=false

      - name: Build and deploy with release profile
        run: mvn -B deploy -Prelease -DskipTests -pl '!it-tests,!shared-tests,!spark35-tests,!spark35_2.12-tests,!spark40-tests,!spark41-tests'
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            core/target/spark-rabbitmq-streams-connector-core-*.jar
            spark35/target/spark-rabbitmq-streams-connector-spark35-*.jar
            spark35_2.12/target/spark-rabbitmq-streams-connector-spark35_2.12-*.jar
            spark40/target/spark-rabbitmq-streams-connector-spark40-*.jar
            spark41/target/spark-rabbitmq-streams-connector-spark41-*.jar
